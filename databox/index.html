<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/favicon.png" />
  <title>AnyJinx — DataBox</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Rubik:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0f1724; --bg2:#071022;
      --accent:#7c5cff; --accent-2:#00e0b8;
      --muted:#9aa4b2; --card:rgba(255,255,255,0.04);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 60%);
      color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:40px;
    }

    .wrap{width:100%; max-width:980px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:20px; padding:28px; box-shadow: 0 10px 30px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(6px) saturate(120%);
    }

    header{display:flex; align-items:center; justify-content:space-between; gap:16px}
    .logo .mark{font-family:Rubik, Inter, sans-serif; font-weight:700; font-size:22px;
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      -webkit-background-clip:text; color:transparent;
    }

    main{display:grid; grid-template-columns:1fr 360px; gap:22px; margin-top:18px}
    .card{padding:18px; border-radius:12px; background:var(--card); border:1px solid rgba(255,255,255,0.03);}

    .form-row{display:flex; gap:10px; align-items:center}
    input[type="text"], input[type="password"]{flex:1; padding:10px; border-radius:8px; border:none;
      background:rgba(255,255,255,0.05); color:#fff; font-size:15px;
    }
    button.btn{padding:10px 14px; border-radius:8px; border:none; background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#071022; font-weight:700; cursor:pointer;
    }
    .note{color:var(--muted); font-size:13px; margin-top:10px;}

    textarea#content{width:100%; min-height:340px; padding:12px; border-radius:10px; border:none;
      background:rgba(255,255,255,0.03); color:#fff; font-family:inherit; font-size:14px; resize:vertical;
    }

    .controls{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
    .debug{color:#ffb86b; margin-top:10px; font-size:13px}

    .status-box{padding:12px; border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.02); color:var(--muted)}

    @media (max-width:880px){ main{grid-template-columns:1fr} .logo .mark{font-size:20px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><div class="mark">AnyJinx — DataBox</div></div>
      <nav aria-label="Main"><button class="btn" onclick="location.href='/'">Home</button></nav>
    </header>

    <main>
      <!-- LEFT: main panel -->
      <section class="card" id="main-card">
        <h2 id="headline">DataBox</h2>

 

        <!-- form for manual box code entry -->
        <div id="box-form">
          <div class="form-row">
            <input id="boxcode" type="text" placeholder="Enter box code">
            <button id="openBoxBtn" class="btn">Open box</button>
          </div>
          <div class="note">If the box exists, you'll be asked for the password.</div>
        </div>

        <!-- dynamic area where login prompt or content appears -->
        <div id="flow" style="margin-top:14px"></div>
      </section>


    <footer style="margin-top:16px; color:var(--muted); font-size:13px;">
      © AnyJinx
    </footer>
  </div>

  <script>
    // Helper: get query param
    function getQueryParam(name) {
      const params = new URLSearchParams(location.search);
      return params.get(name);
    }

    // Helper: SHA-256 hex
    async function sha256hex(text) {
      const enc = new TextEncoder().encode(text);
      const hashBuf = await crypto.subtle.digest('SHA-256', enc);
      const hashArray = Array.from(new Uint8Array(hashBuf));
      return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
    }

    // UI utilities
    const flow = document.getElementById('flow');
    const sideStatus = document.getElementById('side-status');

    function setSideStatus(s){ sideStatus.textContent = s; }

    function showMessage(msg, type='info'){
      flow.innerHTML = `<div class="status-box">${escapeHtml(msg)}</div>`;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

    // Main logic:
    // 1) If ?box=CODE present -> start box flow
    // 2) else allow manual code input

    document.getElementById('openBoxBtn').addEventListener('click', () => {
      const code = document.getElementById('boxcode').value.trim();
      if(!code) { showMessage('Please enter a box code.'); return; }
      startBoxFlow(code);
    });

    // On load check query param
    (function init(){
      const code = getQueryParam('box');
      if(code) startBoxFlow(code);
      else setSideStatus('Ready');
    })();

    // Try fetch helper with friendly messages
    async function tryFetch(path){
      try{
        const res = await fetch(path, {cache:'no-store'});
        if(!res.ok) return {ok:false, status:res.status};
        const txt = await res.text();
        return {ok:true, text:txt};
      }catch(e){
        return {ok:false, error:e.message};
      }
    }

    // Parse hash file format: lines like CODE=hexhash
    function parseHashFile(txt){
      const map = {};
      txt.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).forEach(line=>{
        const idx = line.indexOf('=');
        if(idx>0){
          const code = line.slice(0,idx).trim();
          const hash = line.slice(idx+1).trim().toLowerCase();
          map[code] = hash;
        }
      });
      return map;
    }

    // Start the flow for a given code
    async function startBoxFlow(code){
      flow.innerHTML = `<div class="status-box">Checking for box <strong>${escapeHtml(code)}</strong>…</div>`;
      setSideStatus('Looking up box');

      // load hash list
      const hashPathCandidates = [
        './boxes/hash.txt',
        'boxes/hash.txt',
        '/databox/boxes/hash.txt',
        '/boxes/hash.txt'
      ];
      let hashResult = null;
      for(const p of hashPathCandidates){
        const r = await tryFetch(p);
        if(r.ok){ hashResult = {path:p, text:r.text}; break; }
      }
      if(!hashResult){
        flow.innerHTML = `<div class="status-box">Hash list not found (tried multiple paths). Ensure <code>boxes/hash.txt</code> exists.</div>`;
        setSideStatus('Hash list missing');
        return;
      }

      setSideStatus('Hash list loaded');
      const hashMap = parseHashFile(hashResult.text);
      if(!hashMap.hasOwnProperty(code)){
        flow.innerHTML = `<div class="status-box">Box <strong>${escapeHtml(code)}</strong> does not exist.</div>`;
        setSideStatus('Box not found');
        return;
      }

      const expectedHash = hashMap[code];
      // show password prompt
      renderPasswordPrompt(code, expectedHash);
    }

    function renderPasswordPrompt(code, expectedHash){
      setSideStatus('Awaiting password');
      flow.innerHTML = `
        <div style="margin-bottom:8px">Box <strong>${escapeHtml(code)}</strong> requires a password.</div>
        <div class="form-row">
          <input id="pwInput" type="password" placeholder="Enter password">
          <button id="pwBtn" class="btn">Unlock</button>
        </div>
        <div id="flow-debug" class="debug"></div>
      `;
      document.getElementById('pwBtn').addEventListener('click', async ()=>{
        const v = document.getElementById('pwInput').value;
        if(!v){ document.getElementById('flow-debug').textContent = 'Please enter a password.'; return; }
        document.getElementById('flow-debug').textContent = 'Checking...';
        const computed = await sha256hex(v);
        if(computed.toLowerCase() === expectedHash.toLowerCase()){
          document.getElementById('flow-debug').textContent = 'Password OK — loading box content...';
          await loadBoxContent(code);
        } else {
          document.getElementById('flow-debug').textContent = 'Wrong password.';
        }
      });
      // support Enter
      document.getElementById('pwInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('pwBtn').click(); }});
    }

    async function loadBoxContent(code){
      setSideStatus('Loading content');
      flow.innerHTML = `<div class="status-box">Loading content for <strong>${escapeHtml(code)}</strong>…</div>`;

      // Try some likely paths for the box file
      const candidates = [
        `./boxes/${code}.txt`,
        `boxes/${code}.txt`,
        `/databox/boxes/${code}.txt`,
        `/boxes/${code}.txt`
      ];
      let attempt = null;
      for(const p of candidates){
        const r = await tryFetch(p);
        if(r.ok){ attempt = {path:p, text:r.text}; break; }
      }
      if(!attempt){
        flow.innerHTML = `<div class="status-box">Content file for <strong>${escapeHtml(code)}</strong> not found. (Tried multiple locations)</div>`;
        setSideStatus('Content missing');
        return;
      }

      setSideStatus('Content loaded');
      // show content area (copy/refresh)
      flow.innerHTML = `
        <h4 style="margin:0 0 8px 0">Box: ${escapeHtml(code)}</h4>
        <textarea id="content" readonly>${escapeHtml(attempt.text)}</textarea>
        <div class="controls">
          <button id="copyBtn" class="btn">Copy</button>
          <button id="refreshBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none">Refresh</button>
        </div>
        <div id="flow-debug" class="debug">Loaded from ${escapeHtml(attempt.path)}</div>
      `;

      document.getElementById('copyBtn').addEventListener('click', async ()=>{
        const txt = document.getElementById('content').value;
        try{
          await navigator.clipboard.writeText(txt);
          document.getElementById('flow-debug').textContent = 'Copied to clipboard.';
        }catch(e){
          document.getElementById('content').select();
          try{ document.execCommand('copy'); document.getElementById('flow-debug').textContent = 'Copied (fallback).'; }
          catch(e2){ document.getElementById('flow-debug').textContent = 'Copy failed — select manually.'; }
        }
      });

      document.getElementById('refreshBtn').addEventListener('click', async ()=>{
        // reload content
        setSideStatus('Refreshing content');
        const r = await tryFetch(attempt.path);
        if(r.ok){ document.getElementById('content').value = r.text; document.getElementById('flow-debug').textContent = 'Refreshed.'; setSideStatus('Content loaded'); }
        else{ document.getElementById('flow-debug').textContent = 'Refresh failed.'; setSideStatus('Refresh failed'); }
      });
    }

    // Small nicety: if user typed a code and pressed Enter in the boxcode input
    document.getElementById('boxcode').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('openBoxBtn').click(); }});

  </script>
</body>
</html>
